<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotle.info ‚Äî Quote Database Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --bg-deep: #0f0f1e;
            --bg-surface: #1a1a2e;
            --bg-card: #252538;
            --bg-card-hover: #2d2d45;
            --bg-elevated: #30304a;
            --bg-input: #1e1e30;
            --text-primary: #e8e0f0;
            --text-secondary: #a8b0c0;
            --text-muted: #6b7280;
            --burgundy: #d4627a;
            --burgundy-deep: #8B2635;
            --burgundy-glow: rgba(212, 98, 122, 0.15);
            --gold: #ffd369;
            --gold-dim: rgba(255, 211, 105, 0.12);
            --sage: #7eb38b;
            --sage-dim: rgba(126, 179, 139, 0.12);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.12);
            --blue: #667eea;
            --blue-dim: rgba(102, 126, 234, 0.12);
            --border: rgba(255,255,255,0.06);
            --border-accent: rgba(212, 98, 122, 0.25);
            --radius: 10px;
            --radius-lg: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* === LAYOUT === */
        .app-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* === SIDEBAR === */
        .sidebar {
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-brand {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 900;
            padding: 8px 12px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }
        .sidebar-brand span { color: var(--burgundy); }
        .sidebar-brand small {
            display: block;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: none;
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.88rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }
        .nav-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-btn.active { background: var(--burgundy-glow); color: var(--burgundy); font-weight: 600; }
        .nav-btn .icon { font-size: 1.1rem; width: 24px; text-align: center; }

        .nav-divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }

        .sidebar-stats {
            margin-top: auto;
            padding: 16px 12px;
            background: var(--bg-card);
            border-radius: var(--radius);
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .sidebar-stats .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        .sidebar-stats .stat-value {
            color: var(--gold);
            font-weight: 600;
            font-family: 'DM Mono', monospace;
        }

        /* === MAIN CONTENT === */
        .main-content {
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }
        .page-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 6px;
        }
        .page-header p {
            color: var(--text-secondary);
            font-size: 0.92rem;
        }

        /* === VIEW PANELS (show/hide) === */
        .view-panel { display: none; }
        .view-panel.active { display: block; }

        /* === TOOLBAR === */
        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.88rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--burgundy); }
        .search-input::placeholder { color: var(--text-muted); }

        .filter-select {
            padding: 10px 32px 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7280'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
        }
        .filter-select option { background: var(--bg-card); }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .btn:hover { background: var(--bg-card-hover); border-color: var(--border-accent); }
        .btn-primary {
            background: linear-gradient(135deg, var(--burgundy), var(--burgundy-deep));
            border-color: transparent;
            color: white;
        }
        .btn-primary:hover { box-shadow: 0 4px 16px rgba(212, 98, 122, 0.3); }
        .btn-success { background: var(--sage-dim); border-color: var(--sage); color: var(--sage); }
        .btn-small { padding: 6px 12px; font-size: 0.78rem; }
        .btn-danger { background: var(--red-dim); border-color: transparent; color: var(--red); }

        /* === QUOTES TABLE === */
        .quotes-table-wrap {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .quotes-table {
            width: 100%;
            border-collapse: collapse;
        }

        .quotes-table th {
            text-align: left;
            padding: 14px 16px;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .quotes-table th:hover { color: var(--text-primary); }

        .quotes-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.88rem;
            vertical-align: top;
        }

        .quotes-table tr:hover td { background: var(--bg-card-hover); }
        .quotes-table tr:last-child td { border-bottom: none; }

        .quote-text-cell {
            max-width: 400px;
            font-style: italic;
            color: var(--text-primary);
            cursor: pointer;
        }
        .quote-text-cell:hover { color: var(--burgundy); }

        .author-cell { font-weight: 600; color: var(--gold); white-space: nowrap; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .badge-published { background: var(--sage-dim); color: var(--sage); }
        .badge-draft { background: var(--gold-dim); color: var(--gold); }
        .badge-review { background: var(--blue-dim); color: var(--blue); }
        .badge-needs-enrichment { background: var(--red-dim); color: var(--red); }

        .difficulty-bar {
            display: flex;
            gap: 2px;
            align-items: center;
        }
        .difficulty-pip {
            width: 6px;
            height: 14px;
            border-radius: 2px;
            background: var(--bg-elevated);
        }
        .difficulty-pip.filled { background: var(--burgundy); }

        /* === PAGINATION === */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
        }
        .pagination-info {
            font-size: 0.82rem;
            color: var(--text-muted);
        }
        .pagination-btns {
            display: flex;
            gap: 6px;
        }

        /* === EDITOR MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 24px;
        }
        .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }

        .modal {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 860px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
        }
        .modal-close {
            width: 34px; height: 34px;
            border: none;
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { background: var(--red-dim); color: var(--red); }

        .modal-body {
            padding: 28px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 28px;
            border-top: 1px solid var(--border);
        }

        /* === FORM FIELDS === */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-full { grid-column: 1 / -1; }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .form-group label .required { color: var(--burgundy); }

        .form-input, .form-textarea, .form-select {
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.88rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--burgundy);
        }
        .form-textarea {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7280'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
            cursor: pointer;
        }
        .form-select option { background: var(--bg-card); }

        .form-hint {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .form-section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 700;
            padding: 16px 0 8px;
            border-top: 1px solid var(--border);
            margin-top: 8px;
            color: var(--burgundy);
            grid-column: 1 / -1;
        }

        .tags-input-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            min-height: 42px;
            align-items: center;
            cursor: text;
        }
        .tags-input-wrap:focus-within { border-color: var(--burgundy); }
        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: var(--burgundy-glow);
            border: 1px solid var(--border-accent);
            border-radius: 4px;
            font-size: 0.78rem;
            color: var(--burgundy);
            font-weight: 500;
        }
        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
            line-height: 1;
        }
        .tag-remove:hover { opacity: 1; }
        .tag-input {
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            flex: 1;
            min-width: 80px;
        }

        /* === IMPORT PANEL === */
        .import-box {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            transition: border-color 0.2s;
        }
        .import-box:hover { border-color: var(--border-accent); }
        .import-box .icon { font-size: 2.5rem; margin-bottom: 12px; }
        .import-box h3 { font-size: 1.1rem; margin-bottom: 6px; }
        .import-box p { color: var(--text-muted); font-size: 0.88rem; }

        .import-preview {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'DM Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            margin-bottom: 16px;
        }

        /* === EXPORT PANEL === */
        .export-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .export-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-card:hover {
            border-color: var(--border-accent);
            background: var(--bg-card-hover);
        }
        .export-card .icon { font-size: 2rem; margin-bottom: 10px; }
        .export-card h4 { font-size: 0.92rem; margin-bottom: 4px; }
        .export-card p { font-size: 0.78rem; color: var(--text-muted); }

        /* === STATS DASHBOARD === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }
        .stat-card .stat-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .stat-card .stat-number {
            font-family: 'DM Mono', monospace;
            font-size: 2rem;
            font-weight: 500;
            color: var(--gold);
            margin: 4px 0;
        }
        .stat-card .stat-detail {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        /* === ENRICHMENT CHECKLIST === */
        .enrichment-progress {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .enrichment-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
        }
        .enrichment-dot.done { background: var(--sage); border-color: var(--sage); }
        .enrichment-dot.partial { background: var(--gold); border-color: var(--gold); }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--bg-card);
            border: 1px solid var(--sage);
            border-radius: var(--radius);
            color: var(--sage);
            font-size: 0.88rem;
            font-weight: 500;
            z-index: 2000;
            box-shadow: var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: var(--red); color: var(--red); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        @media (max-width: 900px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .export-options { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- AUTH GATE -->
<div id="authGate" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg-deep);">
    <div style="text-align:center;max-width:400px;padding:40px;">
        <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:900;margin-bottom:8px;">quotle<span style="color:var(--burgundy);">.info</span></div>
        <div style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:32px;">Database Manager</div>
        <p style="color:var(--text-secondary);font-size:0.92rem;margin-bottom:24px;">Sign in with your Google account to manage the quote database.</p>
        <button id="signInBtn" onclick="doSignIn()" style="display:inline-flex;align-items:center;gap:10px;padding:14px 28px;background:linear-gradient(135deg,var(--burgundy),var(--burgundy-deep));border:none;border-radius:10px;color:white;font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:box-shadow 0.2s;">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#fff" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></svg>
            Sign in with Google
        </button>
        <p id="authError" style="color:var(--red);font-size:0.82rem;margin-top:16px;display:none;"></p>
        <p style="color:var(--text-muted);font-size:0.72rem;margin-top:24px;">Uses your existing Game Shelf / Firebase auth</p>
    </div>
</div>

<div class="app-layout" id="appLayout" style="display:none;">
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="sidebar-brand">
            quotle<span>.info</span>
            <small>Database Manager</small>
        </div>
        <div style="display:flex;align-items:center;gap:6px;padding:4px 12px 12px;font-size:0.72rem;color:var(--text-muted);">
            <div id="dbDot" style="width:7px;height:7px;border-radius:50%;background:var(--text-muted);"></div>
            <span id="dbStatusText">Connecting...</span>
        </div>

        <button class="nav-btn active" onclick="showView('dashboard')">
            <span class="icon">üìä</span> Dashboard
        </button>
        <button class="nav-btn" onclick="showView('quotes')">
            <span class="icon">üí¨</span> All Quotes
        </button>
        <button class="nav-btn" onclick="showView('authors')">
            <span class="icon">üë§</span> Authors
        </button>

        <div class="nav-divider"></div>

        <button class="nav-btn" onclick="showView('add')">
            <span class="icon">‚ûï</span> Add Quote
        </button>
        <button class="nav-btn" onclick="showView('import')">
            <span class="icon">üì•</span> Import Quotle
        </button>
        <button class="nav-btn" onclick="showView('export')">
            <span class="icon">üì§</span> Export
        </button>

        <div class="nav-divider"></div>

        <button class="nav-btn" onclick="showView('enrichment')">
            <span class="icon">‚ú®</span> Enrichment Queue
        </button>

        <div class="sidebar-stats" id="sidebarStats">
            <div class="stat-row"><span>Total Quotes</span> <span class="stat-value" id="statTotal">0</span></div>
            <div class="stat-row"><span>Published</span> <span class="stat-value" id="statPublished">0</span></div>
            <div class="stat-row"><span>Need Enrichment</span> <span class="stat-value" id="statNeedsWork">0</span></div>
            <div class="stat-row"><span>Authors</span> <span class="stat-value" id="statAuthors">0</span></div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="main-content">

        <!-- ===== DASHBOARD ===== -->
        <div class="view-panel active" id="view-dashboard">
            <div class="page-header">
                <h1>Dashboard</h1>
                <p>Overview of the quotle.info quote database</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Quotes</div>
                    <div class="stat-number" id="dashTotal">0</div>
                    <div class="stat-detail">in database</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Published</div>
                    <div class="stat-number" id="dashPublished">0</div>
                    <div class="stat-detail">ready for site</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Need Enrichment</div>
                    <div class="stat-number" id="dashNeedsWork">0</div>
                    <div class="stat-detail">source / context missing</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Authors</div>
                    <div class="stat-number" id="dashAuthors">0</div>
                    <div class="stat-detail">in collection</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 12px;">By Status</h3>
                    <div id="dashStatusChart" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px;"></div>
                </div>
                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 12px;">By Period</h3>
                    <div id="dashPeriodChart" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px;"></div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <h3 style="font-size: 1rem; margin-bottom: 12px;">Quick Actions</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showView('import')">üì• Import Quotle Quotes</button>
                    <button class="btn" onclick="showView('add')">‚ûï Add New Quote</button>
                    <button class="btn" onclick="showView('enrichment')">‚ú® View Enrichment Queue</button>
                    <button class="btn btn-success" onclick="showView('export')">üì§ Export Database</button>
                </div>
            </div>
        </div>

        <!-- ===== ALL QUOTES ===== -->
        <div class="view-panel" id="view-quotes">
            <div class="page-header">
                <h1>All Quotes</h1>
                <p>Browse, search, and manage the quote database</p>
            </div>

            <div class="toolbar">
                <input class="search-input" type="text" id="quoteSearchInput" placeholder="Search quotes or authors..." oninput="renderQuotesTable()">
                <select class="filter-select" id="filterStatus" onchange="renderQuotesTable()">
                    <option value="">All Status</option>
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                    <option value="review">Review</option>
                </select>
                <select class="filter-select" id="filterPeriod" onchange="renderQuotesTable()">
                    <option value="">All Periods</option>
                    <option value="Ancient">Ancient</option>
                    <option value="1200s">1200s</option>
                    <option value="1300s">1300s</option>
                    <option value="1500s">1500s</option>
                    <option value="1600s">1600s</option>
                    <option value="1700s">1700s</option>
                    <option value="1800s">1800s</option>
                    <option value="1900s">1900s</option>
                    <option value="2000s">2000s</option>
                </select>
                <select class="filter-select" id="filterCategory" onchange="renderQuotesTable()">
                    <option value="">All Categories</option>
                    <option value="Speech">Speech</option>
                    <option value="Literature">Literature</option>
                    <option value="Philosophy">Philosophy</option>
                    <option value="Business">Business</option>
                    <option value="Science">Science</option>
                </select>
                <button class="btn btn-primary" onclick="showView('add')">‚ûï Add</button>
            </div>

            <div class="quotes-table-wrap">
                <table class="quotes-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('text')">Quote</th>
                            <th onclick="sortTable('authorName')">Author</th>
                            <th onclick="sortTable('source.type')">Type</th>
                            <th onclick="sortTable('gameData.difficultyLevel')">Diff</th>
                            <th onclick="sortTable('status')">Status</th>
                            <th>Enrichment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quotesTableBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <span class="pagination-info" id="paginationInfo"></span>
                <div class="pagination-btns">
                    <button class="btn btn-small" id="prevPageBtn" onclick="changePage(-1)">‚Üê Prev</button>
                    <button class="btn btn-small" id="nextPageBtn" onclick="changePage(1)">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- ===== ADD QUOTE ===== -->
        <div class="view-panel" id="view-add">
            <div class="page-header">
                <h1>Add New Quote</h1>
                <p>Add a quote with the full quotle.info data model</p>
            </div>
            <div id="quoteEditorContainer"></div>
        </div>

        <!-- ===== AUTHORS ===== -->
        <div class="view-panel" id="view-authors">
            <div class="page-header">
                <h1>Authors</h1>
                <p>All authors in the database</p>
            </div>
            <div class="toolbar">
                <input class="search-input" type="text" id="authorSearchInput" placeholder="Search authors..." oninput="renderAuthorsTable()">
            </div>
            <div class="quotes-table-wrap">
                <table class="quotes-table">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Period</th>
                            <th>Category</th>
                            <th>Quotes</th>
                            <th>Avg Difficulty</th>
                        </tr>
                    </thead>
                    <tbody id="authorsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ===== IMPORT ===== -->
        <div class="view-panel" id="view-import">
            <div class="page-header">
                <h1>Import Quotle Quotes</h1>
                <p>Import and transform quotes from the Quotle game database</p>
            </div>

            <div class="import-box" id="importDropZone">
                <div class="icon">üì•</div>
                <h3>Import Quotle Quotes</h3>
                <p>Paste JSON or use the built-in 390 Quotle quotes</p>
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="importBuiltInQuotes()">Import Built-in 390 Quotes</button>
                    <button class="btn" onclick="document.getElementById('importFileInput').click()">Upload JSON File</button>
                </div>
                <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importFromFile(event)">
            </div>

            <div id="importPreview" style="display:none;">
                <h3 style="font-size: 1rem; margin-bottom: 12px;">Import Preview</h3>
                <div class="import-preview" id="importPreviewContent"></div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" id="confirmImportBtn" onclick="confirmImport()">Confirm Import</button>
                    <button class="btn" onclick="cancelImport()">Cancel</button>
                    <span id="importStats" style="font-size: 0.82rem; color: var(--text-muted);"></span>
                </div>
            </div>
        </div>

        <!-- ===== EXPORT ===== -->
        <div class="view-panel" id="view-export">
            <div class="page-header">
                <h1>Export Database</h1>
                <p>Export quotes in various formats for Firebase or backup</p>
            </div>

            <div class="export-options">
                <div class="export-card" onclick="exportFirebase()">
                    <div class="icon">üî•</div>
                    <h4>Firebase JSON</h4>
                    <p>Full data model, ready for import to Firebase RTDB</p>
                </div>
                <div class="export-card" onclick="exportFlat()">
                    <div class="icon">üìã</div>
                    <h4>Flat JSON</h4>
                    <p>Simple array of all quotes for backup</p>
                </div>
                <div class="export-card" onclick="exportCSV()">
                    <div class="icon">üìä</div>
                    <h4>CSV Spreadsheet</h4>
                    <p>For Google Sheets enrichment workflow</p>
                </div>
            </div>

            <div id="exportPreview" style="display:none;">
                <h3 style="font-size: 1rem; margin-bottom: 12px;">Export Preview</h3>
                <div class="import-preview" id="exportPreviewContent"></div>
                <button class="btn btn-primary" onclick="downloadExport()">üì• Download</button>
            </div>
        </div>

        <!-- ===== ENRICHMENT QUEUE ===== -->
        <div class="view-panel" id="view-enrichment">
            <div class="page-header">
                <h1>Enrichment Queue</h1>
                <p>Quotes that need source verification, context, or other enrichment</p>
            </div>

            <div class="toolbar">
                <select class="filter-select" id="enrichFilter" onchange="renderEnrichmentQueue()">
                    <option value="all">All Incomplete</option>
                    <option value="no-source">Missing Source</option>
                    <option value="no-context">Missing Context</option>
                    <option value="no-topics">Missing Topics</option>
                    <option value="no-pd">Missing PD Verification</option>
                </select>
                <span style="font-size: 0.82rem; color: var(--text-muted);" id="enrichCount"></span>
            </div>

            <div class="quotes-table-wrap">
                <table class="quotes-table">
                    <thead>
                        <tr>
                            <th>Quote</th>
                            <th>Author</th>
                            <th>Missing</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="enrichmentTableBody"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">Edit Quote</h2>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-danger" id="modalDeleteBtn" onclick="deleteQuote()" style="margin-right:auto;">üóë Delete</button>
            <button class="btn btn-primary" onclick="saveQuote()">üíæ Save Quote</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// =============================================
// FIREBASE INIT
// =============================================
firebase.initializeApp({
    apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
    authDomain: "word-boxing.firebaseapp.com",
    databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
    projectId: "word-boxing",
    storageBucket: "word-boxing.appspot.com",
    messagingSenderId: "932356027174",
    appId: "1:932356027174:web:0c1c9eeeca785cb49a0d8f"
});
const db = firebase.database();
const QUOTES_REF = db.ref('quotle-info/quotes');
const AUTHORS_REF = db.ref('quotle-info/authors');

// =============================================
// AUTH
// =============================================
let currentUser = null;

function doSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider).catch(err => {
        console.error('Sign-in error:', err);
        const el = document.getElementById('authError');
        el.textContent = err.message;
        el.style.display = 'block';
    });
}

firebase.auth().onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
        document.getElementById('authGate').style.display = 'none';
        document.getElementById('appLayout').style.display = 'grid';
        setDbStatus(true, 'Signed in as ' + (user.displayName || user.email));
        // Start listeners now that we're authed
        startListeners();
    } else {
        document.getElementById('authGate').style.display = 'flex';
        document.getElementById('appLayout').style.display = 'none';
        setDbStatus(false, 'Not signed in');
    }
});

// =============================================
// STATE
// =============================================
let quotesCache = {};
let authorsCache = {};
const PER_PAGE = 25;
let currentPage = 0;
let currentSort = { field: null, dir: 'asc' };
let editingQuoteId = null;
let pendingImport = null;
let exportData = null;
let exportFilename = null;

function setDbStatus(ok, text) {
    const dot = document.getElementById('dbDot');
    if (dot) dot.style.background = ok ? '#7eb38b' : '#ef4444';
    const lbl = document.getElementById('dbStatusText');
    if (lbl) lbl.textContent = text;
}

// =============================================
// REAL-TIME LISTENER ‚Äî starts after auth
// =============================================
let listenersStarted = false;
function startListeners() {
    if (listenersStarted) return;
    listenersStarted = true;

    setDbStatus(true, 'Loading quotes...');
    QUOTES_REF.on('value', snap => {
    quotesCache = snap.val() || {};
    const n = Object.keys(quotesCache).length;
    setDbStatus(true, `Firebase ¬∑ ${n} quotes`);
    updateStats();
    // Refresh whichever view is active
    const av = document.querySelector('.view-panel.active');
    if (av) {
        if (av.id === 'view-dashboard') renderDashboard();
        if (av.id === 'view-quotes') renderQuotesTable();
        if (av.id === 'view-authors') renderAuthorsTable();
        if (av.id === 'view-enrichment') renderEnrichmentQueue();
    }
}, err => { console.error(err); setDbStatus(false, 'Error: ' + err.message); });

AUTHORS_REF.on('value', snap => { authorsCache = snap.val() || {}; });
} // end startListeners

// =============================================
// WRITE HELPERS ‚Äî async Firebase operations
// =============================================
async function fbSetQuote(id, data) {
    await QUOTES_REF.child(id).set(data);
}
async function fbDeleteQuote(id) {
    await QUOTES_REF.child(id).remove();
}
async function fbSetAuthor(id, data) {
    await AUTHORS_REF.child(id).update(data);
}

// =============================================
// ID GENERATION
// =============================================
function generateQuoteId(author, text) {
    return 'quote_' + (author + ' ' + text.substring(0, 40)).toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').substring(0, 60);
}
function generateAuthorId(name) {
    return name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-');
}

// =============================================
// TRANSFORM QUOTLE ‚Üí QUOTLE.INFO
// =============================================
function transformQuotleQuote(q) {
    const quoteId = generateQuoteId(q.author, q.text);
    return {
        id: quoteId, text: q.text,
        cleanText: q.text.toLowerCase().replace(/[^\w\s]/g, '').trim(),
        authorId: generateAuthorId(q.author), authorName: q.author,
        source: { type: (q.category || '').toLowerCase() || 'unknown', title: '', year: parseYear(q.year), publicationDetails: q.location || '', url: '', verified: false, verificationNotes: '' },
        context: '', historicalContext: '', interpretation: '',
        topics: [], themes: [], sentiment: 'inspirational',
        relatedQuotes: [], contradictingQuotes: [], responseQuotes: [],
        keyPhrases: extractKeyPhrases(q.text), wordCount: q.text.split(/\s+/).length,
        famousRating: Math.max(1, 11 - (q.difficulty || 5)),
        commonlyMisattributed: false, misattributedTo: [], variations: [],
        publicDomain: { status: null, jurisdiction: 'US', reason: '', notes: '' },
        gameData: { usedInQuotle: true, quotleIndex: q.index, difficultyLevel: q.difficulty || 5, quotleHint: q.hint || '', quotleCategory: q.category || '', quotlePeriod: q.period || '', quotleLocation: q.location || '' },
        createdAt: Date.now(), updatedAt: Date.now(), curatedBy: 'import', status: 'draft', importedFrom: 'quotle-v1.2.9'
    };
}
function transformAuthor(q) {
    const id = generateAuthorId(q.author);
    return { id, name: q.author, fullName: q.author, slug: id, gender: q.gender || '', era: mapPeriodToEra(q.period), timePeriod: q.period || '', quoteCount: 0, verified: false, createdAt: Date.now(), updatedAt: Date.now() };
}
function parseYear(y) { if (!y) return null; const m = y.match(/\d{4}/); if (m) return parseInt(m[0]); const d = y.match(/(\d{3,4})s/); return d ? parseInt(d[1]) : null; }
function mapPeriodToEra(p) { return { Ancient:'ancient','1200s':'medieval','1300s':'medieval','1500s':'renaissance','1600s':'enlightenment','1700s':'enlightenment','1800s':'modern','1900s':'contemporary','2000s':'contemporary' }[p] || 'unknown'; }
function extractKeyPhrases(text) { const w = text.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/); const p = []; for (let i = 0; i < w.length - 1 && p.length < 3; i++) { if (w[i].length > 3 && w[i+1].length > 3) p.push(w[i] + ' ' + w[i+1]); } return p.length ? p : [w.slice(0, 3).join(' ')]; }

// =============================================
// ENRICHMENT SCORING
// =============================================
function getEnrichmentScore(q) {
    let s=0, m=[];
    if(q.source?.title)s++;else m.push('source');
    if(q.source?.verified)s++;else m.push('verified');
    if(q.context)s++;else m.push('context');
    if(q.topics?.length>0)s++;else m.push('topics');
    if(q.publicDomain?.status!==null&&q.publicDomain?.status!==undefined)s++;else m.push('pd-status');
    if(q.historicalContext)s++;
    return {score:s,total:6,missing:m};
}
function getStatusBadge(s) { return `<span class="badge badge-${s||'draft'}">${s||'draft'}</span>`; }
function getDifficultyPips(l) { let h='<div class="difficulty-bar">'; for(let i=1;i<=10;i++) h+=`<div class="difficulty-pip${i<=l?' filled':''}"></div>`; return h+'</div>'; }
function getEnrichmentDots(q) { const{score,total,missing}=getEnrichmentScore(q); let h='<div class="enrichment-progress" title="'+(missing.length?'Missing: '+missing.join(', '):'Enriched')+'">'; for(let i=0;i<total;i++) h+=`<div class="enrichment-dot${i<score?' done':''}"></div>`; return h+'</div>'; }

// =============================================
// VIEWS
// =============================================
function showView(viewId) {
    document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + viewId)?.classList.add('active');
    const nav = document.querySelectorAll('.nav-btn');
    nav.forEach(b => { if (b.textContent.toLowerCase().includes(viewId === 'add' ? 'add' : viewId === 'enrichment' ? 'enrich' : viewId)) b.classList.add('active'); });
    if (viewId === 'quotes') { currentPage = 0; renderQuotesTable(); }
    if (viewId === 'authors') renderAuthorsTable();
    if (viewId === 'dashboard') renderDashboard();
    if (viewId === 'add') renderAddForm();
    if (viewId === 'enrichment') renderEnrichmentQueue();
}

// =============================================
// QUOTES TABLE
// =============================================
function getFilteredQuotes() {
    const s = (document.getElementById('quoteSearchInput')?.value || '').toLowerCase();
    const st = document.getElementById('filterStatus')?.value || '';
    const p = document.getElementById('filterPeriod')?.value || '';
    const c = document.getElementById('filterCategory')?.value || '';
    return Object.values(quotesCache).filter(q => {
        if (s && !q.text.toLowerCase().includes(s) && !q.authorName.toLowerCase().includes(s)) return false;
        if (st && q.status !== st) return false;
        if (p && q.gameData?.quotlePeriod !== p) return false;
        if (c && q.source?.type !== c.toLowerCase() && q.gameData?.quotleCategory !== c) return false;
        return true;
    });
}

function renderQuotesTable() {
    const filtered = getFilteredQuotes();
    if (currentSort.field) filtered.sort((a, b) => { const av = getNestedVal(a, currentSort.field) || ''; const bv = getNestedVal(b, currentSort.field) || ''; const cmp = String(av).localeCompare(String(bv), undefined, { numeric: true }); return currentSort.dir === 'asc' ? cmp : -cmp; });
    const start = currentPage * PER_PAGE;
    const page = filtered.slice(start, start + PER_PAGE);
    document.getElementById('quotesTableBody').innerHTML = page.map(q => `<tr>
        <td class="quote-text-cell" onclick="openEditor('${q.id}')">"${escapeHtml(q.text.length > 80 ? q.text.substring(0, 80) + '...' : q.text)}"</td>
        <td class="author-cell">${escapeHtml(q.authorName)}</td><td>${q.source?.type || q.gameData?.quotleCategory || '‚Äî'}</td>
        <td>${getDifficultyPips(q.gameData?.difficultyLevel || 5)}</td><td>${getStatusBadge(q.status)}</td><td>${getEnrichmentDots(q)}</td>
        <td><button class="btn btn-small" onclick="openEditor('${q.id}')">‚úèÔ∏è</button></td></tr>`).join('');
    document.getElementById('paginationInfo').textContent = `${start + 1}‚Äì${Math.min(start + PER_PAGE, filtered.length)} of ${filtered.length}`;
    document.getElementById('prevPageBtn').disabled = currentPage === 0;
    document.getElementById('nextPageBtn').disabled = start + PER_PAGE >= filtered.length;
}
function sortTable(f) { if (currentSort.field === f) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc'; else currentSort = { field: f, dir: 'asc' }; renderQuotesTable(); }
function changePage(d) { currentPage = Math.max(0, currentPage + d); renderQuotesTable(); }
function getNestedVal(o, p) { return p.split('.').reduce((a, k) => a?.[k], o); }

// =============================================
// AUTHORS TABLE
// =============================================
function renderAuthorsTable() {
    const s = (document.getElementById('authorSearchInput')?.value || '').toLowerCase();
    const map = {};
    Object.values(quotesCache).forEach(q => { const id = q.authorId; if (!map[id]) map[id] = { name: q.authorName, period: q.gameData?.quotlePeriod || '', category: q.source?.type || q.gameData?.quotleCategory || '', count: 0, totalDiff: 0 }; map[id].count++; map[id].totalDiff += q.gameData?.difficultyLevel || 5; });
    let authors = Object.values(map); if (s) authors = authors.filter(a => a.name.toLowerCase().includes(s)); authors.sort((a, b) => b.count - a.count);
    document.getElementById('authorsTableBody').innerHTML = authors.map(a => `<tr><td class="author-cell">${escapeHtml(a.name)}</td><td>${a.period}</td><td>${a.category}</td><td>${a.count}</td><td>${(a.totalDiff / a.count).toFixed(1)}</td></tr>`).join('');
}

// =============================================
// ENRICHMENT QUEUE
// =============================================
function renderEnrichmentQueue() {
    const filter = document.getElementById('enrichFilter')?.value || 'all';
    const needs = Object.values(quotesCache).filter(q => { const { missing } = getEnrichmentScore(q); if (filter === 'all') return missing.length > 0; return missing.includes(filter.replace('no-', '').replace('pd', 'pd-status')); }).sort((a, b) => (b.famousRating || 0) - (a.famousRating || 0));
    document.getElementById('enrichCount').textContent = `${needs.length} quotes need attention`;
    document.getElementById('enrichmentTableBody').innerHTML = needs.slice(0, 50).map(q => { const { missing } = getEnrichmentScore(q); return `<tr>
        <td class="quote-text-cell" onclick="openEditor('${q.id}')">"${escapeHtml(q.text.length > 70 ? q.text.substring(0, 70) + '...' : q.text)}"</td>
        <td class="author-cell">${escapeHtml(q.authorName)}</td>
        <td>${missing.map(m => `<span class="badge badge-needs-enrichment">${m}</span> `).join('')}</td>
        <td><button class="btn btn-small btn-primary" onclick="openEditor('${q.id}')">‚úèÔ∏è Enrich</button></td></tr>`; }).join('');
}

// =============================================
// DASHBOARD
// =============================================
function renderDashboard() {
    const quotes = Object.values(quotesCache); const pub = quotes.filter(q => q.status === 'published').length; const needs = quotes.filter(q => getEnrichmentScore(q).missing.length > 0).length; const auth = new Set(quotes.map(q => q.authorId)).size;
    document.getElementById('dashTotal').textContent = quotes.length; document.getElementById('dashPublished').textContent = pub; document.getElementById('dashNeedsWork').textContent = needs; document.getElementById('dashAuthors').textContent = auth;
    const statuses = { published: 0, draft: 0, review: 0 }; quotes.forEach(q => { statuses[q.status || 'draft'] = (statuses[q.status || 'draft'] || 0) + 1; });
    document.getElementById('dashStatusChart').innerHTML = Object.entries(statuses).map(([k, v]) => `<div style="display:flex;justify-content:space-between;padding:6px 0;"><span>${k}</span><span style="color:var(--gold);font-family:'DM Mono',monospace;">${v}</span></div>`).join('');
    const periods = {}; quotes.forEach(q => { const p = q.gameData?.quotlePeriod || 'Unknown'; periods[p] = (periods[p] || 0) + 1; });
    document.getElementById('dashPeriodChart').innerHTML = Object.entries(periods).sort((a, b) => b[1] - a[1]).map(([k, v]) => { const pct = (v / quotes.length * 100).toFixed(0); return `<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:3px;"><span>${k}</span><span style="color:var(--text-muted)">${v}</span></div><div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:var(--burgundy);border-radius:3px;"></div></div></div>`; }).join('');
}
function updateStats() {
    const q = Object.values(quotesCache); document.getElementById('statTotal').textContent = q.length; document.getElementById('statPublished').textContent = q.filter(x => x.status === 'published').length; document.getElementById('statNeedsWork').textContent = q.filter(x => getEnrichmentScore(x).missing.length > 0).length; document.getElementById('statAuthors').textContent = new Set(q.map(x => x.authorId)).size;
}

// =============================================
// EDITOR (Add / Edit)
// =============================================
function renderAddForm() { editingQuoteId = null; document.getElementById('quoteEditorContainer').innerHTML = buildEditorHTML({}); initTagInputs(); }
function openEditor(quoteId) { editingQuoteId = quoteId; const q = quotesCache[quoteId]; if (!q) return; document.getElementById('modalTitle').textContent = 'Edit Quote'; document.getElementById('modalBody').innerHTML = buildEditorHTML(q); document.getElementById('modalDeleteBtn').style.display = ''; document.getElementById('editModal').classList.add('active'); initTagInputs(); }

function buildEditorHTML(q) {
    const types = ['speech','book','letter','interview','essay','article','philosophy','literature','other'];
    const sents = ['inspirational','philosophical','humorous','critical','reflective','sardonic'];
    const stats = ['draft','review','published','archived'];
    return `<div class="form-grid">
        <div class="form-group form-full"><label>Quote Text <span class="required">*</span></label><textarea class="form-textarea" id="ed-text" rows="3">${escapeHtml(q.text || '')}</textarea></div>
        <div class="form-group"><label>Author Name <span class="required">*</span></label><input class="form-input" id="ed-authorName" value="${escapeHtml(q.authorName || '')}"></div>
        <div class="form-group"><label>Status</label><select class="form-select" id="ed-status">${stats.map(s => `<option value="${s}"${q.status === s ? ' selected' : ''}>${s}</option>`).join('')}</select></div>
        <div class="form-section-title">üìÑ Source Information</div>
        <div class="form-group"><label>Source Type</label><select class="form-select" id="ed-sourceType"><option value="">Select...</option>${types.map(t => `<option value="${t}"${q.source?.type === t ? ' selected' : ''}>${t}</option>`).join('')}</select></div>
        <div class="form-group"><label>Source Title</label><input class="form-input" id="ed-sourceTitle" value="${escapeHtml(q.source?.title || '')}"></div>
        <div class="form-group"><label>Year</label><input class="form-input" id="ed-sourceYear" type="number" value="${q.source?.year || ''}"></div>
        <div class="form-group"><label>Publication</label><input class="form-input" id="ed-sourcePub" value="${escapeHtml(q.source?.publicationDetails || '')}"></div>
        <div class="form-group form-full"><label>Source URL</label><input class="form-input" id="ed-sourceUrl" value="${escapeHtml(q.source?.url || '')}"></div>
        <div class="form-group"><label>Verified</label><select class="form-select" id="ed-sourceVerified"><option value="false"${!q.source?.verified ? ' selected' : ''}>Not Verified</option><option value="true"${q.source?.verified ? ' selected' : ''}>Verified ‚úì</option></select></div>
        <div class="form-group"><label>Notes</label><input class="form-input" id="ed-sourceNotes" value="${escapeHtml(q.source?.verificationNotes || '')}"></div>
        <div class="form-section-title">üí° Context & Interpretation</div>
        <div class="form-group form-full"><label>Context (Why It Matters)</label><textarea class="form-textarea" id="ed-context" rows="3">${escapeHtml(q.context || '')}</textarea></div>
        <div class="form-group form-full"><label>Historical Context</label><textarea class="form-textarea" id="ed-historicalContext" rows="2">${escapeHtml(q.historicalContext || '')}</textarea></div>
        <div class="form-group form-full"><label>Interpretation</label><textarea class="form-textarea" id="ed-interpretation" rows="2">${escapeHtml(q.interpretation || '')}</textarea></div>
        <div class="form-section-title">üè∑Ô∏è Categorization</div>
        <div class="form-group"><label>Topics</label><div class="tags-input-wrap" id="ed-topics-wrap">${(q.topics || []).map(t => `<span class="tag-item">${t}<span class="tag-remove" onclick="removeTag(this)">√ó</span></span>`).join('')}<input class="tag-input" placeholder="Type + Enter" onkeydown="handleTagKey(event, this)"></div></div>
        <div class="form-group"><label>Themes</label><div class="tags-input-wrap" id="ed-themes-wrap">${(q.themes || []).map(t => `<span class="tag-item">${t}<span class="tag-remove" onclick="removeTag(this)">√ó</span></span>`).join('')}<input class="tag-input" placeholder="Type + Enter" onkeydown="handleTagKey(event, this)"></div></div>
        <div class="form-group"><label>Sentiment</label><select class="form-select" id="ed-sentiment">${sents.map(s => `<option value="${s}"${q.sentiment === s ? ' selected' : ''}>${s}</option>`).join('')}</select></div>
        <div class="form-group"><label>Famous Rating (1-10)</label><input class="form-input" id="ed-famousRating" type="number" min="1" max="10" value="${q.famousRating || 5}"></div>
        <div class="form-section-title">üìú Public Domain</div>
        <div class="form-group"><label>Status</label><select class="form-select" id="ed-pdStatus"><option value=""${q.publicDomain?.status == null ? ' selected' : ''}>Unknown</option><option value="true"${q.publicDomain?.status === true ? ' selected' : ''}>Yes ‚Äî Public Domain</option><option value="false"${q.publicDomain?.status === false ? ' selected' : ''}>No ‚Äî Copyrighted</option></select></div>
        <div class="form-group"><label>Reason</label><input class="form-input" id="ed-pdReason" value="${escapeHtml(q.publicDomain?.reason || '')}"></div>
        <div class="form-section-title">‚ö†Ô∏è Misattribution</div>
        <div class="form-group"><label>Commonly Misattributed?</label><select class="form-select" id="ed-misattributed"><option value="false"${!q.commonlyMisattributed ? ' selected' : ''}>No</option><option value="true"${q.commonlyMisattributed ? ' selected' : ''}>Yes</option></select></div>
        <div class="form-group"><label>Misattributed To</label><div class="tags-input-wrap" id="ed-misattributedTo-wrap">${(q.misattributedTo || []).map(t => `<span class="tag-item">${t}<span class="tag-remove" onclick="removeTag(this)">√ó</span></span>`).join('')}<input class="tag-input" placeholder="Type + Enter" onkeydown="handleTagKey(event, this)"></div></div>
    </div>`;
}

// Tag inputs
function initTagInputs() { document.querySelectorAll('.tags-input-wrap').forEach(w => w.addEventListener('click', () => w.querySelector('.tag-input')?.focus())); }
function handleTagKey(e, input) { if (e.key === 'Enter' && input.value.trim()) { e.preventDefault(); const w = input.closest('.tags-input-wrap'); const tag = document.createElement('span'); tag.className = 'tag-item'; tag.innerHTML = `${escapeHtml(input.value.trim())}<span class="tag-remove" onclick="removeTag(this)">√ó</span>`; w.insertBefore(tag, input); input.value = ''; } }
function removeTag(el) { el.closest('.tag-item').remove(); }
function getTagValues(id) { const w = document.getElementById(id); if (!w) return []; return Array.from(w.querySelectorAll('.tag-item')).map(t => t.textContent.replace('√ó', '').trim()); }

// =============================================
// SAVE QUOTE ‚Üí FIREBASE
// =============================================
async function saveQuote() {
    const text = document.getElementById('ed-text')?.value?.trim();
    const authorName = document.getElementById('ed-authorName')?.value?.trim();
    if (!text || !authorName) { showToast('Quote text and author required', true); return; }

    const quoteId = editingQuoteId || generateQuoteId(authorName, text);
    const existing = quotesCache[quoteId] || {};
    const authorId = generateAuthorId(authorName);
    const pdVal = document.getElementById('ed-pdStatus')?.value;

    const quote = {
        ...existing, id: quoteId, text, cleanText: text.toLowerCase().replace(/[^\w\s]/g, '').trim(),
        authorId, authorName,
        source: { ...(existing.source || {}), type: document.getElementById('ed-sourceType')?.value || '', title: document.getElementById('ed-sourceTitle')?.value || '', year: parseInt(document.getElementById('ed-sourceYear')?.value) || null, publicationDetails: document.getElementById('ed-sourcePub')?.value || '', url: document.getElementById('ed-sourceUrl')?.value || '', verified: document.getElementById('ed-sourceVerified')?.value === 'true', verificationNotes: document.getElementById('ed-sourceNotes')?.value || '' },
        context: document.getElementById('ed-context')?.value || '', historicalContext: document.getElementById('ed-historicalContext')?.value || '', interpretation: document.getElementById('ed-interpretation')?.value || '',
        topics: getTagValues('ed-topics-wrap'), themes: getTagValues('ed-themes-wrap'),
        sentiment: document.getElementById('ed-sentiment')?.value || 'inspirational',
        famousRating: parseInt(document.getElementById('ed-famousRating')?.value) || 5,
        publicDomain: { ...(existing.publicDomain || {}), status: pdVal === '' ? null : pdVal === 'true', reason: document.getElementById('ed-pdReason')?.value || '' },
        commonlyMisattributed: document.getElementById('ed-misattributed')?.value === 'true',
        misattributedTo: getTagValues('ed-misattributedTo-wrap'),
        status: document.getElementById('ed-status')?.value || 'draft',
        wordCount: text.split(/\s+/).length, keyPhrases: extractKeyPhrases(text),
        updatedAt: Date.now(), createdAt: existing.createdAt || Date.now(),
        gameData: existing.gameData || {}
    };

    try {
        await fbSetQuote(quoteId, quote);
        // Upsert author
        const authorCount = Object.values(quotesCache).filter(q => q.authorId === authorId).length + (editingQuoteId ? 0 : 1);
        await fbSetAuthor(authorId, { id: authorId, name: authorName, slug: authorId, quoteCount: authorCount, updatedAt: Date.now(), createdAt: authorsCache[authorId]?.createdAt || Date.now() });
        closeModal();
        showToast(editingQuoteId ? 'Quote updated in Firebase' : 'Quote added to Firebase');
        if (document.getElementById('view-add').classList.contains('active')) renderAddForm();
    } catch (err) {
        showToast('Firebase error: ' + err.message, true);
    }
}

async function deleteQuote() {
    if (!editingQuoteId || !confirm('Delete this quote from Firebase?')) return;
    try { await fbDeleteQuote(editingQuoteId); closeModal(); showToast('Quote deleted from Firebase'); } catch (err) { showToast('Error: ' + err.message, true); }
}

function closeModal() { document.getElementById('editModal').classList.remove('active'); editingQuoteId = null; }

// =============================================
// IMPORT ‚Üí FIREBASE
// =============================================
function importBuiltInQuotes() { showToast('Upload your quotle-quotes-all.json file'); document.getElementById('importFileInput').click(); }

function importFromFile(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const quotes = Array.isArray(data) ? data : (data.quotes ? Object.values(data.quotes) : []);
            if (!quotes.length) throw new Error('No quotes found');
            pendingImport = quotes;
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('importPreviewContent').textContent = JSON.stringify(quotes.slice(0, 3), null, 2) + '\n\n... and ' + (quotes.length - 3) + ' more';
            const isQuotleFormat = quotes[0].index !== undefined && quotes[0].hint !== undefined;
            document.getElementById('importStats').textContent = `${quotes.length} quotes (${isQuotleFormat ? 'Quotle format ‚Üí will transform' : 'quotle.info format'})`;
        } catch (err) { showToast('Invalid JSON: ' + err.message, true); }
    };
    reader.readAsText(file);
}

async function confirmImport() {
    if (!pendingImport) return;
    let imported = 0, skipped = 0, total = pendingImport.length;
    showToast(`Importing ${total} quotes to Firebase...`);

    const updates = {}; const authorUpdates = {};
    pendingImport.forEach(q => {
        const isQuotleFormat = q.index !== undefined && q.hint !== undefined;
        const transformed = isQuotleFormat ? transformQuotleQuote(q) : q;
        if (quotesCache[transformed.id]) { skipped++; } else {
            updates['quotle-info/quotes/' + transformed.id] = transformed;
            imported++;
            const aid = transformed.authorId;
            if (!authorsCache[aid] && !authorUpdates[aid]) {
                authorUpdates[aid] = isQuotleFormat ? transformAuthor(q) : { id: aid, name: transformed.authorName, slug: aid, createdAt: Date.now() };
            }
        }
    });

    // Write authors
    for (const [aid, author] of Object.entries(authorUpdates)) {
        updates['quotle-info/authors/' + aid] = author;
    }

    try {
        await db.ref().update(updates);
        pendingImport = null;
        document.getElementById('importPreview').style.display = 'none';
        showToast(`‚úÖ Imported ${imported} quotes to Firebase (${skipped} skipped as duplicates)`);
    } catch (err) {
        showToast('Firebase import error: ' + err.message, true);
    }
}

function cancelImport() { pendingImport = null; document.getElementById('importPreview').style.display = 'none'; }

// =============================================
// EXPORT (from Firebase cache)
// =============================================
function exportFirebase() {
    const out = { quotes: {}, authors: {} };
    Object.values(quotesCache).forEach(q => { const d = { ...q }; delete d.id; out.quotes[q.id] = d; });
    Object.values(authorsCache).forEach(a => { const d = { ...a }; delete d.id; out.authors[a.id] = d; });
    exportData = JSON.stringify(out, null, 2); exportFilename = `quotle-info-firebase-${new Date().toISOString().split('T')[0]}.json`;
    document.getElementById('exportPreview').style.display = 'block'; document.getElementById('exportPreviewContent').textContent = exportData.substring(0, 2000) + (exportData.length > 2000 ? '\n\n...' : '');
    showToast(`Firebase export ready: ${Object.keys(quotesCache).length} quotes`);
}
function exportFlat() {
    exportData = JSON.stringify(Object.values(quotesCache), null, 2); exportFilename = `quotle-info-quotes-${new Date().toISOString().split('T')[0]}.json`;
    document.getElementById('exportPreview').style.display = 'block'; document.getElementById('exportPreviewContent').textContent = exportData.substring(0, 2000);
    showToast(`Flat export: ${Object.keys(quotesCache).length} quotes`);
}
function exportCSV() {
    const qs = Object.values(quotesCache);
    const h = 'id,text,authorName,source_type,source_title,source_year,source_verified,context,topics,themes,status,difficulty';
    const rows = qs.map(q => [q.id, csvEsc(q.text), csvEsc(q.authorName), q.source?.type||'', csvEsc(q.source?.title||''), q.source?.year||'', q.source?.verified||'', csvEsc(q.context||''), (q.topics||[]).join(';'), (q.themes||[]).join(';'), q.status||'', q.gameData?.difficultyLevel||''].join(','));
    exportData = h + '\n' + rows.join('\n'); exportFilename = `quotle-info-${new Date().toISOString().split('T')[0]}.csv`;
    document.getElementById('exportPreview').style.display = 'block'; document.getElementById('exportPreviewContent').textContent = exportData.substring(0, 2000);
    showToast(`CSV: ${qs.length} rows`);
}
function downloadExport() { if (!exportData) return; const b = new Blob([exportData], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = exportFilename; a.click(); URL.revokeObjectURL(a.href); showToast('Downloaded ' + exportFilename); }
function csvEsc(s) { return '"' + String(s || '').replace(/"/g, '""') + '"'; }

// =============================================
// UTILITIES
// =============================================
function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function showToast(msg, err) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast' + (err ? ' error' : ''); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => t.classList.remove('show'), 3500); }

document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Init
updateStats();
renderDashboard();
</script>
</body>
</html>
